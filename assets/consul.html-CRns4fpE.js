import{_ as s,c as a,a as p,o as e}from"./app-B4ALHgv8.js";const t={};function l(i,n){return e(),a("div",null,n[0]||(n[0]=[p(`<h2 id="consul" tabindex="-1"><a class="header-anchor" href="#consul"><span>Consul</span></a></h2><p>服务发现</p><h2 id="i-o模型" tabindex="-1"><a class="header-anchor" href="#i-o模型"><span>i/o模型</span></a></h2><p>阻塞I/O，同步</p><p>非阻塞I/O，先返回，再轮询</p><p>I/O多路复用select，单线程处理多socket</p><p>AIO，处理完回调。</p><h3 id="常用命令" tabindex="-1"><a class="header-anchor" href="#常用命令"><span>常用命令</span></a></h3><ul><li>consul agent <ul><li>-h</li><li>-dev</li><li>-bind 指定</li><li>http-port=8500 自带web访问的默认端口</li><li>-client=127.0.0.1 默认本机可以访问consul</li><li>-config-dir=foo 所有主动注册的服务的描述信息</li><li>-data-dir=path 储存所有注册过来的srv机器的详细信息</li><li>-dev 开发者模式</li><li>-node=hostname 服务发现的名字</li><li>-rejoin consul启动的时候，加入到的集群</li><li>-server 以服务方式开启consul，允许其他的consul连接到开启的consul，形成集群。不加就是，以客户端方式开启</li><li>-ui 可以使用web页面</li><li>members</li><li>info</li><li>Leave 关闭</li></ul></li></ul><h3 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h3><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">brew tap hashicorp/tap</span>
<span class="line">brew <span class="token function">install</span> hashicorp/tap/consul</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="运行" tabindex="-1"><a class="header-anchor" href="#运行"><span>运行</span></a></h4><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre><code><span class="line">consul agent <span class="token parameter variable">-server</span> -bootstrap-expect <span class="token number">1</span> -data-dir /Users/xx/consul/tmp/consul <span class="token parameter variable">-node</span><span class="token operator">=</span>n1 <span class="token parameter variable">-bind</span><span class="token operator">=</span><span class="token number">127.0</span>.0.1 <span class="token parameter variable">-ui</span> <span class="token parameter variable">-rejoin</span> -config-dir<span class="token operator">=</span>/Users/xx/consul/consul.d/ <span class="token parameter variable">-client</span> <span class="token number">0.0</span>.0.0</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><img src="http://image.alane.top/tp/2022/12/02/6389e08bbe90d.png" alt="image-20221202192459233"></p><p>注册服务/目录，重新启动</p><div class="language-json line-numbers-mode" data-highlighter="prismjs" data-ext="json" data-title="json"><pre><code><span class="line"><span class="token punctuation">{</span> <span class="token property">&quot;service&quot;</span><span class="token operator">:</span></span>
<span class="line"> <span class="token punctuation">{</span></span>
<span class="line">   <span class="token property">&quot;name&quot;</span><span class="token operator">:</span><span class="token string">&quot;wwowo&quot;</span><span class="token punctuation">,</span></span>
<span class="line">   <span class="token property">&quot;tags&quot;</span><span class="token operator">:</span><span class="token punctuation">[</span><span class="token string">&quot;itcast&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;itheima&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span></span>
<span class="line">   <span class="token property">&quot;port&quot;</span><span class="token operator">:</span><span class="token number">8800</span></span>
<span class="line"> <span class="token punctuation">}</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="http://image.alane.top/tp/2022/12/02/6389e2435bb42.png" alt="image-20221202193219009"></p><h3 id="go代码" tabindex="-1"><a class="header-anchor" href="#go代码"><span>go代码</span></a></h3><h4 id="服务注册" tabindex="-1"><a class="header-anchor" href="#服务注册"><span>服务注册</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">   <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">   <span class="token string">&quot;github.com/hashicorp/consul/api&quot;</span></span>
<span class="line">   <span class="token string">&quot;golang.org/x/net/context&quot;</span></span>
<span class="line">   <span class="token string">&quot;google.golang.org/grpc&quot;</span></span>
<span class="line">   <span class="token string">&quot;net&quot;</span></span>
<span class="line">   <span class="token string">&quot;pb&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">type</span> world <span class="token keyword">struct</span> <span class="token punctuation">{</span></span>
<span class="line">   pb<span class="token punctuation">.</span>UnimplementedHelloServer</span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token punctuation">(</span>this <span class="token operator">*</span>world<span class="token punctuation">)</span> <span class="token function">SayHello</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">,</span> per <span class="token operator">*</span>pb<span class="token punctuation">.</span>Person<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token operator">*</span>pb<span class="token punctuation">.</span>Person<span class="token punctuation">,</span> <span class="token builtin">error</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">   per<span class="token punctuation">.</span>Name <span class="token operator">=</span> <span class="token string">&quot;你你你&quot;</span></span>
<span class="line">   per<span class="token punctuation">.</span>Age <span class="token operator">=</span> <span class="token string">&quot;18&quot;</span></span>
<span class="line">   <span class="token keyword">return</span> per<span class="token punctuation">,</span> <span class="token boolean">nil</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">   <span class="token comment">// 把grpc服务,注册到consul上.</span></span>
<span class="line">   <span class="token comment">// 1. 初始化 consul 配置</span></span>
<span class="line">   consulConfig <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">DefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">   <span class="token comment">// 2. 创建 consul 对象</span></span>
<span class="line">   consulClient<span class="token punctuation">,</span> err <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>consulConfig<span class="token punctuation">)</span></span>
<span class="line">   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;api.NewClient err:&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span></span>
<span class="line">      <span class="token keyword">return</span></span>
<span class="line">   <span class="token punctuation">}</span></span>
<span class="line">   <span class="token comment">// 3. 告诉consul, 即将注册的服务的配置信息</span></span>
<span class="line">   reg <span class="token operator">:=</span> api<span class="token punctuation">.</span>AgentServiceRegistration <span class="token punctuation">{</span></span>
<span class="line">      ID<span class="token punctuation">:</span><span class="token string">&quot;bj38&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      Tags<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token builtin">string</span><span class="token punctuation">{</span><span class="token string">&quot;grcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;consul&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">      Name<span class="token punctuation">:</span><span class="token string">&quot;grpc And Consul&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      Address<span class="token punctuation">:</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      Port<span class="token punctuation">:</span><span class="token number">8800</span><span class="token punctuation">,</span></span>
<span class="line">      Check<span class="token punctuation">:</span><span class="token operator">&amp;</span>api<span class="token punctuation">.</span>AgentServiceCheck<span class="token punctuation">{</span></span>
<span class="line">         CheckID<span class="token punctuation">:</span><span class="token string">&quot;consul grpc test&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         TCP<span class="token punctuation">:</span><span class="token string">&quot;127.0.0.1:8800&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         Timeout<span class="token punctuation">:</span><span class="token string">&quot;1s&quot;</span><span class="token punctuation">,</span></span>
<span class="line">         Interval<span class="token punctuation">:</span><span class="token string">&quot;5s&quot;</span><span class="token punctuation">,</span></span>
<span class="line">      <span class="token punctuation">}</span><span class="token punctuation">,</span></span>
<span class="line">   <span class="token punctuation">}</span></span>
<span class="line"></span>
<span class="line">   <span class="token comment">// 4. 注册 grpc 服务到 consul 上</span></span>
<span class="line">   consulClient<span class="token punctuation">.</span><span class="token function">Agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServiceRegister</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>reg<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">   <span class="token comment">// 初始化grpc</span></span>
<span class="line">   server <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">NewServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">   pb<span class="token punctuation">.</span><span class="token function">RegisterHelloServer</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>world<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">   listen<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;127.0.0.1:8800&quot;</span><span class="token punctuation">)</span></span>
<span class="line">   <span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span></span>
<span class="line">      fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;net.Listen&quot;</span><span class="token punctuation">,</span>err<span class="token punctuation">)</span></span>
<span class="line">   <span class="token punctuation">}</span></span>
<span class="line">   <span class="token keyword">defer</span> listen<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">   server<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>listen<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>服务调用</p><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token punctuation">(</span></span>
<span class="line">   <span class="token string">&quot;fmt&quot;</span></span>
<span class="line">   <span class="token string">&quot;github.com/hashicorp/consul/api&quot;</span></span>
<span class="line">   <span class="token string">&quot;golang.org/x/net/context&quot;</span></span>
<span class="line">   <span class="token string">&quot;google.golang.org/grpc&quot;</span></span>
<span class="line">   <span class="token string">&quot;pb&quot;</span></span>
<span class="line">   <span class="token string">&quot;strconv&quot;</span></span>
<span class="line"><span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line"></span>
<span class="line">   config <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">DefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">   newClient<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span></span>
<span class="line">   service<span class="token punctuation">,</span> <span class="token boolean">_</span><span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> newClient<span class="token punctuation">.</span><span class="token function">Health</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Service</span><span class="token punctuation">(</span><span class="token string">&quot;grpc And Consul&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;grcp&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span></span>
<span class="line">   agentService <span class="token operator">:=</span> service<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Service</span>
<span class="line">   address <span class="token operator">:=</span> agentService<span class="token punctuation">.</span>Address <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> strconv<span class="token punctuation">.</span><span class="token function">Itoa</span><span class="token punctuation">(</span>agentService<span class="token punctuation">.</span>Port<span class="token punctuation">)</span></span>
<span class="line"></span>
<span class="line">   dial<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> grpc<span class="token punctuation">.</span><span class="token function">Dial</span><span class="token punctuation">(</span>address<span class="token punctuation">,</span> grpc<span class="token punctuation">.</span><span class="token function">WithInsecure</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">   <span class="token keyword">defer</span> dial<span class="token punctuation">.</span><span class="token function">Close</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">   client <span class="token operator">:=</span> pb<span class="token punctuation">.</span><span class="token function">NewHelloClient</span><span class="token punctuation">(</span>dial<span class="token punctuation">)</span></span>
<span class="line">   person<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> client<span class="token punctuation">.</span><span class="token function">SayHello</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span><span class="token function">TODO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">new</span><span class="token punctuation">(</span>pb<span class="token punctuation">.</span>Person<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">   fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>person<span class="token punctuation">.</span>Name<span class="token punctuation">,</span> person<span class="token punctuation">.</span>Age<span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="服务注销" tabindex="-1"><a class="header-anchor" href="#服务注销"><span>服务注销</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="prismjs" data-ext="go" data-title="go"><pre><code><span class="line"><span class="token keyword">package</span> main</span>
<span class="line"></span>
<span class="line"><span class="token keyword">import</span> <span class="token string">&quot;github.com/hashicorp/consul/api&quot;</span></span>
<span class="line"></span>
<span class="line"><span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></span>
<span class="line">   config <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">DefaultConfig</span><span class="token punctuation">(</span><span class="token punctuation">)</span></span>
<span class="line">   client<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> api<span class="token punctuation">.</span><span class="token function">NewClient</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span></span>
<span class="line">   client<span class="token punctuation">.</span><span class="token function">Agent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ServiceDeregister</span><span class="token punctuation">(</span><span class="token string">&quot;bj38&quot;</span><span class="token punctuation">)</span></span>
<span class="line"><span class="token punctuation">}</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,24)]))}const o=s(t,[["render",l]]),u=JSON.parse('{"path":"/blogs/xuexi/go/consul.html","title":"consul","lang":"en-US","frontmatter":{"title":"consul","date":"2022-11-30T22:00:07.000Z","author":"Hireek","categories":["go"]},"headers":[{"level":2,"title":"Consul","slug":"consul","link":"#consul","children":[]},{"level":2,"title":"i/o模型","slug":"i-o模型","link":"#i-o模型","children":[{"level":3,"title":"常用命令","slug":"常用命令","link":"#常用命令","children":[]},{"level":3,"title":"安装","slug":"安装","link":"#安装","children":[]},{"level":3,"title":"go代码","slug":"go代码","link":"#go代码","children":[]}]}],"git":{},"filePathRelative":"blogs/学习/go/consul.md"}');export{o as comp,u as data};
